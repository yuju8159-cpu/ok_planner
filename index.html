<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ²–ç¹©æ—…éŠå°å¹«æ‰‹</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body {
            background-color: #f0f9ff; /* Light Ocean Blue */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        input, select, textarea {
            font-size: 16px; /* Prevent zoom on iOS */
        }
        @keyframes slide-up {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up {
            animation: slide-up 0.3s ease-out forwards;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Icons Components ---
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // --- Helper Functions ---
        const generateId = () => Math.random().toString(36).substr(2, 9);
        
        const parseUrl = (text) => {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.split(urlRegex).map((part, i) => {
                if (part.match(urlRegex)) {
                    return <a key={i} href={part} target="_blank" rel="noopener noreferrer" className="text-blue-600 underline break-all block my-1">ğŸ”— {part}</a>;
                }
                return part;
            });
        };

        // --- Initial Data ---
        const DEFAULT_CHECKLIST = [
            { id: '1', text: 'è­·ç…§ (æœ‰æ•ˆæœŸ6å€‹æœˆä»¥ä¸Š)', checked: false },
            { id: '2', text: 'VJW (Visit Japan Web) ç™»éŒ„æˆªåœ–', checked: false },
            { id: '3', text: 'æ—¥å¹£ç¾é‡‘ / ä¿¡ç”¨å¡ / è¥¿ç“œå¡', checked: false },
            { id: '4', text: 'é§•ç…§æ—¥æ–‡è­¯æœ¬ (è‡ªé§•å¿…å‚™)', checked: false },
            { id: '5', text: 'è¡Œå‹•é›»æº / å……é›»ç·š / ç¶²å¡', checked: false },
            { id: '6', text: 'å€‹äººè—¥å“ / æšˆè»Šè—¥', checked: false },
        ];

        const INFO_LINKS = {
            weather: "https://www.jma.go.jp/bosai/forecast/#area_type=offices&area_code=471000",
            embassy: "https://www.roc-taiwan.org/jpna/index.html",
        };

        // --- Main App Component ---
        const App = () => {
            // --- State ---
            const [activeTab, setActiveTab] = useState('itinerary');
            
            // Data States
            const [travelers, setTravelers] = useState(['æˆ‘', 'æ—…ä¼´A']);
            const [days, setDays] = useState([{ id: 'd1', date: '2025-06-01', note: 'æŠµé”æ²–ç¹©' }]);
            const [events, setEvents] = useState([]); // { id, dayId, time, title, location, mapUrl, note }
            const [expenses, setExpenses] = useState([]); // { id, date, title, amount, payer, splits: {}, settled: false }
            const [currency, setCurrency] = useState({ rate: 0.22, symbol: 'JPY' }); // 1 JPY = 0.22 TWD
            const [checklist, setChecklist] = useState(DEFAULT_CHECKLIST);
            const [memo, setMemo] = useState('');
            
            // --- Persistence ---
            useEffect(() => {
                const load = (key, setter) => {
                    const saved = localStorage.getItem(`okinawa_${key}`);
                    if (saved) setter(JSON.parse(saved));
                };
                load('travelers', setTravelers);
                load('days', setDays);
                load('events', setEvents);
                load('expenses', setExpenses);
                load('currency', setCurrency);
                load('checklist', setChecklist);
                load('memo', setMemo);
            }, []);

            useEffect(() => {
                const save = (key, data) => localStorage.setItem(`okinawa_${key}`, JSON.stringify(data));
                save('travelers', travelers);
                save('days', days);
                save('events', events);
                save('expenses', expenses);
                save('currency', currency);
                save('checklist', checklist);
                save('memo', memo);
            }, [travelers, days, events, expenses, currency, checklist, memo]);

            // --- Component Rendering ---
            const renderContent = () => {
                switch (activeTab) {
                    case 'itinerary': return <ItineraryView days={days} setDays={setDays} events={events} setEvents={setEvents} />;
                    case 'map': return <MapView events={events} />;
                    case 'money': return <MoneyView travelers={travelers} expenses={expenses} setExpenses={setExpenses} currency={currency} setCurrency={setCurrency} />;
                    case 'tools': return <ToolsView checklist={checklist} setChecklist={setChecklist} memo={memo} setMemo={setMemo} />;
                    case 'info': return <InfoView />;
                    case 'settings': return <SettingsView travelers={travelers} setTravelers={setTravelers} setExpenses={setExpenses} />;
                    default: return <ItineraryView />;
                }
            };

            return (
                <div className="flex flex-col h-screen max-w-md mx-auto bg-white shadow-xl overflow-hidden">
                    {/* Header */}
                    <header className="bg-gradient-to-r from-cyan-500 to-blue-500 p-4 text-white shadow-md z-10">
                        <h1 className="text-xl font-bold flex items-center justify-center gap-2">
                            <Icon name="palmtree" /> æ²–ç¹©è‡ªç”±è¡Œ
                        </h1>
                    </header>

                    {/* Main Content Area */}
                    <main className="flex-1 overflow-y-auto bg-slate-50 relative">
                        {renderContent()}
                    </main>

                    {/* Bottom Navigation */}
                    <nav className="bg-white border-t border-gray-200 flex justify-around p-2 pb-safe">
                        <NavBtn id="itinerary" icon="calendar" label="è¡Œç¨‹" active={activeTab} set={setActiveTab} />
                        <NavBtn id="map" icon="map" label="å°èˆª" active={activeTab} set={setActiveTab} />
                        <NavBtn id="money" icon="wallet" label="è¨˜å¸³" active={activeTab} set={setActiveTab} />
                        <NavBtn id="tools" icon="clipboard-list" label="æ¸…å–®" active={activeTab} set={setActiveTab} />
                        <NavBtn id="info" icon="info" label="è³‡è¨Š" active={activeTab} set={setActiveTab} />
                        <NavBtn id="settings" icon="settings" label="è¨­å®š" active={activeTab} set={setActiveTab} />
                    </nav>
                </div>
            );
        };

        const NavBtn = ({ id, icon, label, active, set }) => (
            <button 
                onClick={() => set(id)}
                className={`flex flex-col items-center p-2 rounded-lg transition-colors ${active === id ? 'text-blue-600' : 'text-gray-400 hover:text-blue-400'}`}
            >
                <Icon name={icon} size={24} />
                <span className="text-xs mt-1">{label}</span>
            </button>
        );

        // --- 1. Itinerary View (Updated with Tabs) ---
        const ItineraryView = ({ days, setDays, events, setEvents }) => {
            const [isEditingEvent, setIsEditingEvent] = useState(null);
            // Default to first day if available
            const [selectedDayId, setSelectedDayId] = useState(days.length > 0 ? days[0].id : null);

            // Ensure selectedDayId is valid when days change (e.g. deletion)
            useEffect(() => {
                if (days.length > 0) {
                     if (!selectedDayId || !days.find(d => d.id === selectedDayId)) {
                        setSelectedDayId(days[0].id);
                     }
                } else {
                    setSelectedDayId(null);
                }
            }, [days, selectedDayId]);

            const addDay = () => {
                const lastDate = days.length > 0 ? new Date(days[days.length - 1].date) : new Date();
                lastDate.setDate(lastDate.getDate() + 1);
                const newId = generateId();
                setDays([...days, { id: newId, date: lastDate.toISOString().split('T')[0], note: '' }]);
                setSelectedDayId(newId); // Auto switch to new day
            };

            const removeDay = (id) => {
                if(confirm("ç¢ºå®šåˆªé™¤é€™ä¸€å¤©å—ï¼Ÿè¡Œç¨‹ä¹Ÿæœƒè¢«åˆªé™¤ã€‚")) {
                    setDays(days.filter(d => d.id !== id));
                    setEvents(events.filter(e => e.dayId !== id));
                }
            };
            
            const handleSaveEvent = (eventData) => {
                if (eventData.id) {
                    setEvents(events.map(e => e.id === eventData.id ? eventData : e));
                } else {
                    setEvents([...events, { ...eventData, id: generateId() }]);
                }
                setIsEditingEvent(null);
            };

            const deleteEvent = (id) => {
                if(confirm("åˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ")) setEvents(events.filter(e => e.id !== id));
            };

            const currentDay = days.find(d => d.id === selectedDayId);

            return (
                <div className="pb-20 h-full flex flex-col">
                    {/* Header Tabs */}
                    <div className="sticky top-0 bg-white/95 backdrop-blur z-20 shadow-sm border-b border-gray-100">
                        <div className="flex items-center gap-2 p-3 overflow-x-auto hide-scrollbar">
                            {days.map((day, index) => (
                                <button
                                    key={day.id}
                                    onClick={() => setSelectedDayId(day.id)}
                                    className={`flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold transition-all shadow-sm border ${
                                        selectedDayId === day.id 
                                        ? 'bg-blue-500 text-white border-blue-600 ring-2 ring-blue-200' 
                                        : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'
                                    }`}
                                >
                                    Day {index + 1}
                                </button>
                            ))}
                            <button 
                                onClick={addDay} 
                                className="flex-shrink-0 w-9 h-9 rounded-full bg-blue-50 text-blue-600 border border-blue-200 flex items-center justify-center hover:bg-blue-100 transition-colors shadow-sm"
                            >
                                <Icon name="plus" size={18} />
                            </button>
                        </div>
                    </div>

                    {/* Content Area */}
                    <div className="p-4 flex-1">
                        {!currentDay ? (
                            <div className="flex flex-col items-center justify-center h-64 text-gray-400">
                                <Icon name="calendar-off" size={48} className="mb-2 opacity-50"/>
                                <p>ç›®å‰æ²’æœ‰è¡Œç¨‹</p>
                                <button onClick={addDay} className="text-blue-500 font-bold mt-2">æ–°å¢ç¬¬ä¸€å¤©</button>
                            </div>
                        ) : (
                            <div className="animate-slide-up">
                                <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden min-h-[60vh]">
                                    <div className="bg-gray-50/50 p-4 flex justify-between items-center border-b border-gray-100">
                                        <div className="flex items-center gap-2">
                                            <div className="bg-blue-100 text-blue-700 px-3 py-1 rounded-lg font-bold text-sm">
                                                {new Date(currentDay.date).toLocaleDateString('zh-TW', {month: 'short', day: 'numeric'})}
                                            </div>
                                            <input 
                                                type="date" 
                                                value={currentDay.date} 
                                                onChange={(e) => setDays(days.map(d => d.id === currentDay.id ? {...d, date: e.target.value} : d))}
                                                className="bg-transparent text-sm font-medium text-gray-600 focus:outline-none focus:text-blue-600"
                                            />
                                        </div>
                                        <button onClick={() => removeDay(currentDay.id)} className="text-gray-400 hover:text-red-500 p-2 rounded-full hover:bg-red-50 transition-colors">
                                            <Icon name="trash-2" size={18}/>
                                        </button>
                                    </div>
                                    
                                    <div className="p-3 space-y-3">
                                        {events.filter(e => e.dayId === currentDay.id).length === 0 && (
                                            <div className="text-center py-10 text-gray-300 text-sm italic">
                                                é»æ“Šä¸‹æ–¹æŒ‰éˆ•æ–°å¢è¡Œç¨‹
                                            </div>
                                        )}
                                        {events.filter(e => e.dayId === currentDay.id).sort((a,b) => a.time.localeCompare(b.time)).map(event => (
                                            <div key={event.id} className="flex gap-4 items-start p-3 bg-white rounded-xl border border-gray-50 hover:border-blue-100 hover:shadow-md transition-all group">
                                                <div className="text-sm font-mono font-bold text-blue-500 mt-0.5 bg-blue-50 px-2 py-1 rounded">{event.time}</div>
                                                <div className="flex-1 min-w-0">
                                                    <div className="font-bold text-gray-800 truncate">{event.title}</div>
                                                    {event.location && (
                                                        <a href={event.mapUrl || `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(event.location)}`} 
                                                           target="_blank" 
                                                           className="text-xs text-gray-500 flex items-center gap-1 mt-1 hover:text-blue-500 truncate">
                                                            <Icon name="map-pin" size={12} /> {event.location}
                                                        </a>
                                                    )}
                                                    {event.note && <div className="text-xs text-gray-400 mt-2 bg-gray-50 p-2 rounded">{event.note}</div>}
                                                </div>
                                                <div className="flex flex-col gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <button onClick={() => setIsEditingEvent(event)} className="text-gray-300 hover:text-blue-500"><Icon name="edit-2" size={16}/></button>
                                                    <button onClick={() => deleteEvent(event.id)} className="text-gray-300 hover:text-red-500"><Icon name="x" size={16}/></button>
                                                </div>
                                            </div>
                                        ))}
                                        
                                        <button 
                                            onClick={() => setIsEditingEvent({ dayId: currentDay.id, time: '10:00', title: '', location: '', mapUrl: '', note: '' })}
                                            className="w-full py-3 mt-4 rounded-xl border-2 border-dashed border-gray-200 text-gray-400 hover:border-blue-300 hover:text-blue-500 hover:bg-blue-50 transition-all text-sm font-bold flex items-center justify-center gap-2"
                                        >
                                            <Icon name="plus-circle" size={18}/> æ–°å¢è¡Œç¨‹
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Edit Modal */}
                    {isEditingEvent && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white w-full max-w-sm rounded-2xl p-5 space-y-4 shadow-2xl animate-slide-up">
                                <div className="flex justify-between items-center mb-2">
                                    <h3 className="font-bold text-xl text-gray-800">{isEditingEvent.id ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹'}</h3>
                                    <button onClick={() => setIsEditingEvent(null)} className="text-gray-400 hover:text-gray-600"><Icon name="x" size={24}/></button>
                                </div>
                                <div className="grid grid-cols-3 gap-3">
                                    <div className="col-span-1">
                                        <label className="text-xs font-bold text-gray-500 mb-1 block">æ™‚é–“</label>
                                        <input type="time" className="w-full bg-gray-50 border-transparent rounded-lg p-2 focus:bg-white focus:ring-2 ring-blue-200 outline-none transition" value={isEditingEvent.time} onChange={e => setIsEditingEvent({...isEditingEvent, time: e.target.value})} />
                                    </div>
                                    <div className="col-span-2">
                                        <label className="text-xs font-bold text-gray-500 mb-1 block">åç¨±</label>
                                        <input type="text" placeholder="è¡Œç¨‹åç¨±" className="w-full bg-gray-50 border-transparent rounded-lg p-2 focus:bg-white focus:ring-2 ring-blue-200 outline-none transition" value={isEditingEvent.title} onChange={e => setIsEditingEvent({...isEditingEvent, title: e.target.value})} />
                                    </div>
                                </div>
                                
                                <div>
                                    <label className="text-xs font-bold text-gray-500 mb-1 block">åœ°é»</label>
                                    <div className="relative">
                                        <Icon name="map-pin" size={16} className="absolute left-3 top-3 text-gray-400"/>
                                        <input type="text" placeholder="æœå°‹åœ°é»æˆ–è¼¸å…¥åç¨±" className="w-full pl-9 bg-gray-50 border-transparent rounded-lg p-2 focus:bg-white focus:ring-2 ring-blue-200 outline-none transition" value={isEditingEvent.location} onChange={e => setIsEditingEvent({...isEditingEvent, location: e.target.value})} />
                                    </div>
                                </div>

                                <div>
                                    <label className="text-xs font-bold text-gray-500 mb-1 block">åœ°åœ–é€£çµ (é¸å¡«)</label>
                                    <input type="text" placeholder="è²¼ä¸Š Google Maps URL" className="w-full bg-gray-50 border-transparent rounded-lg p-2 focus:bg-white focus:ring-2 ring-blue-200 outline-none transition text-sm" value={isEditingEvent.mapUrl} onChange={e => setIsEditingEvent({...isEditingEvent, mapUrl: e.target.value})} />
                                </div>

                                <div>
                                    <label className="text-xs font-bold text-gray-500 mb-1 block">å‚™è¨»</label>
                                    <textarea placeholder="ä¾‹å¦‚: é–€ç¥¨ 500 yen" className="w-full h-20 bg-gray-50 border-transparent rounded-lg p-2 focus:bg-white focus:ring-2 ring-blue-200 outline-none transition resize-none" value={isEditingEvent.note} onChange={e => setIsEditingEvent({...isEditingEvent, note: e.target.value})}></textarea>
                                </div>

                                <button onClick={() => handleSaveEvent(isEditingEvent)} className="w-full py-3 bg-gradient-to-r from-cyan-500 to-blue-500 rounded-xl text-white font-bold shadow-lg shadow-blue-200 active:scale-[0.98] transition-transform">å„²å­˜è¡Œç¨‹</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- 2. Map Navigation View ---
        const MapView = ({ events }) => {
            const validEvents = events.filter(e => e.location || e.mapUrl);
            
            return (
                <div className="p-4 space-y-4">
                    <h2 className="text-lg font-bold text-gray-700">åœ°åœ–å°èˆª</h2>
                    <div className="bg-yellow-50 text-yellow-800 p-3 rounded-lg text-sm border border-yellow-200">
                        æç¤ºï¼šé»æ“ŠæŒ‰éˆ•ç›´æ¥é–‹å•Ÿ Google Maps App å°èˆªã€‚
                    </div>
                    {validEvents.length === 0 ? (
                        <div className="text-center text-gray-400 py-10">å°šç„¡è¡Œç¨‹åœ°é»è³‡æ–™</div>
                    ) : (
                        <div className="grid gap-3">
                            {validEvents.map(e => {
                                const url = e.mapUrl || `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(e.location)}`;
                                return (
                                    <a key={e.id} href={url} target="_blank" className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between hover:bg-blue-50 transition">
                                        <div>
                                            <div className="font-bold text-gray-800">{e.title}</div>
                                            <div className="text-sm text-gray-500">{e.location}</div>
                                        </div>
                                        <div className="bg-blue-100 text-blue-600 p-2 rounded-full">
                                            <Icon name="navigation" size={20} />
                                        </div>
                                    </a>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        };

        // --- 3. Money View (Complex & Fixed) ---
        const MoneyView = ({ travelers, expenses, setExpenses, currency, setCurrency }) => {
            const [viewMode, setViewMode] = useState('list'); // list, add, settle, report
            const [newExpense, setNewExpense] = useState(null);

            // Calculation Logic
            const report = useMemo(() => {
                let balances = {};
                travelers.forEach(t => balances[t] = 0);
                
                let totalSpent = 0;
                let activeExpenses = expenses.filter(e => !e.settled);

                activeExpenses.forEach(exp => {
                    const amount = parseFloat(exp.amount);
                    if(isNaN(amount)) return;
                    totalSpent += amount;
                    
                    // Payer paid (+)
                    balances[exp.payer] += amount;

                    // Splitters owe (-)
                    Object.entries(exp.splits).forEach(([person, splitAmount]) => {
                        balances[person] -= parseFloat(splitAmount);
                    });
                });

                // Generate Debt List
                let debtors = [];
                let creditors = [];
                Object.entries(balances).forEach(([person, amount]) => {
                    if (amount < -0.1) debtors.push({ person, amount }); // owes money
                    if (amount > 0.1) creditors.push({ person, amount }); // receives money
                });

                debtors.sort((a, b) => a.amount - b.amount);
                creditors.sort((a, b) => b.amount - a.amount);

                let transfers = [];
                let i = 0; // debtor index
                let j = 0; // creditor index

                while (i < debtors.length && j < creditors.length) {
                    let debtor = debtors[i];
                    let creditor = creditors[j];
                    let amount = Math.min(Math.abs(debtor.amount), creditor.amount);
                    
                    transfers.push({
                        from: debtor.person,
                        to: creditor.person,
                        amount: amount.toFixed(0)
                    });

                    debtor.amount += amount;
                    creditor.amount -= amount;

                    if (Math.abs(debtor.amount) < 0.1) i++;
                    if (creditor.amount < 0.1) j++;
                }

                return { totalSpent, transfers, balances };
            }, [expenses, travelers]);

            const initAddExpense = () => {
                const initialSplits = {};
                travelers.forEach(t => initialSplits[t] = 0); // Init with 0, user enters amount or use auto
                setNewExpense({
                    id: generateId(),
                    date: new Date().toISOString().split('T')[0],
                    title: '',
                    amount: '',
                    payer: travelers[0],
                    splits: initialSplits,
                    splitType: 'equal', // equal, custom
                    settled: false
                });
                setViewMode('add');
            };

            const saveExpense = () => {
                // Validation
                if (!newExpense.title || !newExpense.amount) return alert("è«‹è¼¸å…¥é …ç›®å’Œé‡‘é¡");
                const total = parseFloat(newExpense.amount);
                
                let finalSplits = {...newExpense.splits};
                if (newExpense.splitType === 'equal') {
                    const share = total / travelers.length;
                    travelers.forEach(t => finalSplits[t] = share);
                } else {
                    // Check sum
                    const currentSum = Object.values(finalSplits).reduce((a, b) => a + parseFloat(b || 0), 0);
                    if (Math.abs(currentSum - total) > 1) {
                        return alert(`é‡‘é¡éŒ¯èª¤ï¼\n\nè‡ªè¨‚åˆ†æ”¤çš„ç¸½å’Œ (${currentSum}) èˆ‡ ç¸½é‡‘é¡ (${total}) ä¸ç¬¦ã€‚\n\nè«‹èª¿æ•´åˆ†æ”¤é‡‘é¡ï¼Œæˆ–åˆ‡æ›ç‚ºã€Œå‡åˆ†ã€æ¨¡å¼ã€‚`);
                    }
                }

                const expenseToSave = { ...newExpense, splits: finalSplits, amount: total };
                
                // Edit or Add
                const existingIndex = expenses.findIndex(e => e.id === expenseToSave.id);
                if (existingIndex >= 0) {
                    const updated = [...expenses];
                    updated[existingIndex] = expenseToSave;
                    setExpenses(updated);
                } else {
                    setExpenses([expenseToSave, ...expenses]);
                }
                setViewMode('list');
            };

            const toggleSettle = (date) => {
                if(confirm(`ç¢ºå®šå°‡ ${date} ä»¥å‰(å«)çš„æ‰€æœ‰æœªçµç®—é …ç›®æ¨™è¨˜ç‚ºå·²çµç®—ï¼Ÿ`)) {
                    setExpenses(expenses.map(e => {
                        if (e.date <= date && !e.settled) return { ...e, settled: true };
                        return e;
                    }));
                }
            };
            
            const deleteExpense = (id) => {
                if(confirm("ç¢ºå®šè¦åˆªé™¤æ­¤ç­†è¨˜å¸³ç´€éŒ„å—ï¼Ÿ")) {
                    setExpenses(prev => prev.filter(e => e.id !== id));
                }
            };

            const editExpense = (exp) => {
                // Intelligent Split Detection: Check if current splits are effectively equal
                const values = Object.values(exp.splits).map(v => parseFloat(v) || 0);
                const total = parseFloat(exp.amount) || 0;
                const avg = total / travelers.length;
                
                // If every split is within 1.0 of the average, treat it as Equal mode
                const isEqual = values.every(v => Math.abs(v - avg) < 1.0);
                
                setNewExpense({
                    ...exp, 
                    splitType: isEqual ? 'equal' : 'custom',
                    // Force deep copy of splits
                    splits: {...exp.splits} 
                });
                setViewMode('add');
            };

            // Render Sub-Components
            if (viewMode === 'add') {
                const currentSplitSum = Object.values(newExpense.splits).reduce((a, b) => a + parseFloat(b || 0), 0);
                const remaining = parseFloat(newExpense.amount || 0) - currentSplitSum;

                return (
                    <div className="p-4 bg-white min-h-full">
                        <div className="flex items-center mb-4">
                            <button onClick={() => setViewMode('list')} className="mr-2"><Icon name="arrow-left"/></button>
                            <h2 className="text-xl font-bold">{newExpense.id && expenses.find(e=>e.id === newExpense.id) ? 'ç·¨è¼¯è¨˜å¸³' : 'æ–°å¢è¨˜å¸³'}</h2>
                        </div>
                        <div className="space-y-4">
                            <div>
                                <label className="text-xs text-gray-500">æ—¥æœŸ</label>
                                <input type="date" className="w-full border-b p-2" value={newExpense.date} onChange={e => setNewExpense({...newExpense, date: e.target.value})} />
                            </div>
                            <div>
                                <label className="text-xs text-gray-500">é …ç›®åç¨±</label>
                                <input type="text" placeholder="ä¾‹å¦‚: æ™šé¤" className="w-full border-b p-2 text-lg" value={newExpense.title} onChange={e => setNewExpense({...newExpense, title: e.target.value})} />
                            </div>
                            <div className="flex gap-2">
                                <div className="flex-1">
                                    <label className="text-xs text-gray-500">ç¸½é‡‘é¡ ({currency.symbol})</label>
                                    <input type="number" placeholder="0" className="w-full border-b p-2 text-2xl font-bold text-blue-600" value={newExpense.amount} onChange={e => setNewExpense({...newExpense, amount: e.target.value})} />
                                </div>
                                <div className="w-1/3">
                                    <label className="text-xs text-gray-500">ä»˜æ¬¾äºº</label>
                                    <select className="w-full border-b p-2 h-[46px]" value={newExpense.payer} onChange={e => setNewExpense({...newExpense, payer: e.target.value})}>
                                        {travelers.map(t => <option key={t} value={t}>{t}</option>)}
                                    </select>
                                </div>
                            </div>

                            <div className="bg-gray-50 p-3 rounded-lg border border-gray-100">
                                <div className="flex justify-between mb-2">
                                    <label className="text-sm font-bold text-gray-600">åˆ†æ”¤æ–¹å¼</label>
                                    <div className="flex gap-2 text-xs">
                                        <button onClick={() => setNewExpense({...newExpense, splitType: 'equal'})} className={`px-2 py-1 rounded transition ${newExpense.splitType === 'equal' ? 'bg-blue-500 text-white shadow' : 'bg-gray-200 text-gray-600'}`}>å‡åˆ†</button>
                                        <button onClick={() => setNewExpense({...newExpense, splitType: 'custom'})} className={`px-2 py-1 rounded transition ${newExpense.splitType === 'custom' ? 'bg-blue-500 text-white shadow' : 'bg-gray-200 text-gray-600'}`}>è‡ªè¨‚</button>
                                    </div>
                                </div>
                                {newExpense.splitType === 'custom' ? (
                                    <div className="space-y-2">
                                        {travelers.map(t => (
                                            <div key={t} className="flex justify-between items-center bg-white p-2 rounded border border-gray-100">
                                                <span>{t}</span>
                                                <input type="number" 
                                                    className="w-24 border rounded p-1 text-right font-mono" 
                                                    value={newExpense.splits[t]} 
                                                    onChange={(e) => setNewExpense({...newExpense, splits: {...newExpense.splits, [t]: e.target.value}})}
                                                />
                                            </div>
                                        ))}
                                        {/* Validation Helper */}
                                        <div className={`text-xs text-right mt-2 font-bold ${Math.abs(remaining) > 1 ? 'text-red-500' : 'text-green-500'}`}>
                                            {Math.abs(remaining) > 1 
                                                ? `âš ï¸ é‚„æœ‰ ${remaining.toFixed(0)} æœªåˆ†é… (ç¸½å’Œéœ€ç­‰æ–¼ ${newExpense.amount})`
                                                : 'âœ… é‡‘é¡åˆ†é…æ­£ç¢º'}
                                        </div>
                                    </div>
                                ) : (
                                    <div className="text-sm text-gray-500 bg-white p-3 rounded border border-gray-100 flex justify-between">
                                        <span>æ¯äººåˆ†æ”¤:</span>
                                        <span className="font-bold text-blue-600 font-mono">
                                            {newExpense.amount ? (newExpense.amount / travelers.length).toFixed(0) : 0}
                                        </span>
                                    </div>
                                )}
                            </div>

                            <button onClick={saveExpense} className="w-full bg-blue-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-200 active:scale-[0.98] transition">å„²å­˜</button>
                        </div>
                    </div>
                );
            }

            // List View & Report View
            return (
                <div className="p-4 space-y-4 pb-20">
                    {/* Header Controls */}
                    <div className="flex justify-between items-center">
                        <h2 className="text-lg font-bold text-gray-700">è²¡å‹™ç®¡å®¶</h2>
                        <div className="flex gap-2 text-sm">
                             <div className="flex items-center gap-1 bg-white px-2 py-1 rounded border">
                                <span className="text-xs text-gray-400">åŒ¯ç‡ 1:{currency.rate}</span>
                                <input type="number" className="w-12 text-center border-b" value={currency.rate} step="0.01" onChange={(e) => setCurrency({...currency, rate: parseFloat(e.target.value)})} />
                            </div>
                        </div>
                    </div>

                    {/* Report Card */}
                    <div className="bg-gradient-to-br from-blue-600 to-cyan-500 rounded-xl p-4 text-white shadow-lg">
                        <div className="flex justify-between items-end mb-4">
                            <div>
                                <div className="text-blue-100 text-sm">æœªçµç®—ç¸½æ”¯å‡º</div>
                                <div className="text-3xl font-bold">Â¥ {report.totalSpent.toLocaleString()}</div>
                                <div className="text-xs text-blue-100 mt-1">â‰ˆ NT$ {(report.totalSpent * currency.rate).toFixed(0)}</div>
                            </div>
                            <button onClick={initAddExpense} className="bg-white text-blue-600 px-4 py-2 rounded-full font-bold shadow flex items-center gap-1">
                                <Icon name="plus" size={16} /> è¨˜ä¸€ç­†
                            </button>
                        </div>
                        
                        {report.transfers.length > 0 ? (
                            <div className="bg-white/10 rounded-lg p-3 text-sm backdrop-blur-sm">
                                <div className="font-bold mb-2 flex items-center gap-1"><Icon name="refresh-cw" size={14}/> å»ºè­°çµç®—æ–¹å¼</div>
                                {report.transfers.map((t, idx) => (
                                    <div key={idx} className="flex justify-between border-b border-white/20 last:border-0 py-1">
                                        <span>{t.from} <Icon name="arrow-right" size={12} className="inline"/> {t.to}</span>
                                        <span className="font-mono">Â¥{t.amount} (NT${(t.amount*currency.rate).toFixed(0)})</span>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="bg-white/10 rounded-lg p-2 text-center text-sm">ç›®å‰ç„¡äººæ¬ æ¬¾ï¼Œå®Œç¾ï¼</div>
                        )}
                    </div>

                    {/* Expense List Grouped by Date */}
                    <div className="space-y-4">
                        {Object.entries(expenses.reduce((acc, curr) => {
                            (acc[curr.date] = acc[curr.date] || []).push(curr);
                            return acc;
                        }, {})).sort((a,b) => b[0].localeCompare(a[0])).map(([date, items]) => {
                            const allSettled = items.every(i => i.settled);
                            return (
                                <div key={date} className={`bg-white rounded-xl shadow-sm overflow-hidden border ${allSettled ? 'opacity-60 grayscale' : 'border-gray-100'}`}>
                                    <div className="bg-gray-50 px-3 py-2 flex justify-between items-center text-sm border-b border-gray-100">
                                        <span className="font-bold text-gray-700">{date}</span>
                                        {!allSettled && (
                                            <button 
                                                onClick={(e) => { e.stopPropagation(); toggleSettle(date); }} 
                                                className="text-xs text-green-600 bg-green-100 px-2 py-1 rounded hover:bg-green-200"
                                            >
                                                çµæ¸…æ­¤æ—¥ä¹‹å‰
                                            </button>
                                        )}
                                        {allSettled && <span className="text-xs bg-gray-200 text-gray-500 px-2 py-1 rounded">å·²çµç®—</span>}
                                    </div>
                                    <div className="divide-y divide-gray-50">
                                        {items.map(exp => (
                                            <div key={exp.id} className="p-3 flex justify-between items-center hover:bg-gray-50 group">
                                                <div onClick={() => !exp.settled && editExpense(exp)} className="flex-1 cursor-pointer">
                                                    <div className="font-semibold text-gray-800">{exp.title}</div>
                                                    <div className="text-xs text-gray-500">
                                                        <span className="bg-blue-100 text-blue-800 px-1 rounded mr-1">{exp.payer}</span>
                                                        ä»˜ Â¥{parseFloat(exp.amount).toLocaleString()}
                                                    </div>
                                                </div>
                                                {!exp.settled && (
                                                    <button 
                                                        onClick={(e) => { e.stopPropagation(); deleteExpense(exp.id); }} 
                                                        className="text-gray-300 hover:text-red-500 p-2 rounded-full hover:bg-red-50"
                                                    >
                                                        <Icon name="trash-2" size={18}/>
                                                    </button>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // --- 4. Tools View (Checklist & Memo) ---
        const ToolsView = ({ checklist, setChecklist, memo, setMemo }) => {
            const toggleCheck = (id) => {
                setChecklist(checklist.map(i => i.id === id ? { ...i, checked: !i.checked } : i));
            };

            const addCheckItem = (e) => {
                if(e.key === 'Enter' && e.target.value.trim()) {
                    setChecklist([...checklist, { id: generateId(), text: e.target.value, checked: false }]);
                    e.target.value = '';
                }
            };

            const deleteCheckItem = (id) => {
                 setChecklist(checklist.filter(i => i.id !== id));
            }

            return (
                <div className="p-4 space-y-6">
                    {/* Checklist */}
                    <div>
                        <h2 className="text-lg font-bold text-gray-700 mb-3 flex items-center gap-2"><Icon name="check-square"/> è¡Œå‰æ¸…å–®</h2>
                        <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                            <input type="text" placeholder="+ æ–°å¢é …ç›® (Enter)" onKeyDown={addCheckItem} className="w-full p-3 border-b bg-gray-50 focus:bg-white focus:outline-none" />
                            <div className="divide-y divide-gray-100">
                                {checklist.map(item => (
                                    <div key={item.id} className="flex items-center p-3 hover:bg-gray-50 group">
                                        <input 
                                            type="checkbox" 
                                            checked={item.checked} 
                                            onChange={() => toggleCheck(item.id)}
                                            className="w-5 h-5 text-blue-600 rounded focus:ring-blue-500"
                                        />
                                        <span className={`flex-1 ml-3 ${item.checked ? 'line-through text-gray-400' : 'text-gray-700'}`}>{item.text}</span>
                                        <button onClick={() => deleteCheckItem(item.id)} className="text-gray-300 hover:text-red-400 opacity-0 group-hover:opacity-100"><Icon name="x" size={16}/></button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Memo */}
                    <div className="flex-1 flex flex-col h-full">
                        <h2 className="text-lg font-bold text-gray-700 mb-3 flex items-center gap-2"><Icon name="file-text"/> å€‹äººå‚™å¿˜éŒ„</h2>
                        <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-1 flex-1">
                            <textarea 
                                className="w-full h-32 p-2 resize-none focus:outline-none text-sm text-gray-600 border-b border-dashed"
                                placeholder="è¼¸å…¥ç­†è¨˜æˆ–ç¶²å€..."
                                value={memo}
                                onChange={(e) => setMemo(e.target.value)}
                            ></textarea>
                            <div className="p-2 bg-gray-50 text-sm text-gray-600 min-h-[50px] rounded">
                                <div className="text-xs text-gray-400 mb-1">é è¦½ (é€£çµå¯é»æ“Š):</div>
                                {memo ? parseUrl(memo) : <span className="text-gray-300">å°šæœªè¼¸å…¥å…§å®¹</span>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 5. Info View ---
        const InfoView = () => {
            return (
                <div className="p-4 space-y-4">
                    <h2 className="text-lg font-bold text-gray-700">å¯¦ç”¨è³‡è¨Š</h2>
                    
                    <div className="grid grid-cols-2 gap-3">
                         <a href={INFO_LINKS.weather} target="_blank" className="bg-gradient-to-br from-orange-400 to-red-400 text-white p-4 rounded-xl shadow flex flex-col items-center justify-center gap-2">
                            <Icon name="sun" size={32} />
                            <span className="font-bold">å¤©æ°£é å ±</span>
                        </a>
                        <a href={INFO_LINKS.embassy} target="_blank" className="bg-gradient-to-br from-blue-400 to-indigo-400 text-white p-4 rounded-xl shadow flex flex-col items-center justify-center gap-2">
                            <Icon name="building" size={32} />
                            <span className="font-bold">è¾¦äº‹è™•</span>
                        </a>
                    </div>

                    <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                        <h3 className="font-bold text-red-500 mb-2 flex items-center gap-2"><Icon name="phone" size={16}/> ç·Šæ€¥è¯çµ¡</h3>
                        <ul className="space-y-2 text-sm text-gray-700">
                            <li className="flex justify-between border-b pb-1"><span>è­¦å¯Ÿå±€</span> <span className="font-mono font-bold">110</span></li>
                            <li className="flex justify-between border-b pb-1"><span>ç«è­¦/æ•‘è­·è»Š</span> <span className="font-mono font-bold">119</span></li>
                            <li className="flex justify-between pt-1"><span>å¤–äº¤éƒ¨ç·Šæ€¥è¯çµ¡</span> <span className="font-mono font-bold">080-1009-7179</span></li>
                        </ul>
                    </div>

                    <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                        <h3 className="font-bold text-gray-700 mb-2 flex items-center gap-2"><Icon name="alert-triangle" size={16}/> æ—…éŠæ³¨æ„äº‹é …</h3>
                        <ul className="list-disc list-inside text-sm text-gray-600 space-y-1">
                            <li>æ—¥æœ¬è»Šè¼›é å·¦è¡Œé§›ï¼Œéé¦¬è·¯å…ˆçœ‹å³å†çœ‹å·¦ã€‚</li>
                            <li>è‡ªé§•è«‹åš´æ ¼éµå®ˆé€Ÿé™ï¼Œ"æ­¢ã¾ã‚Œ"æ¨™èªŒå‹™å¿…å®Œå…¨åœæ­¢ã€‚</li>
                            <li>ä¸èƒ½æ”œå¸¶è‚‰é¡è£½å“å…¥å¢ƒæ—¥æœ¬ã€‚</li>
                            <li>å¤§éƒ¨åˆ†å®¤å…§å…¬å…±å ´æ‰€åŠè¡—é“ç¦æ­¢å¸ç…™ã€‚</li>
                            <li>çµå¸³æ™‚å°‡ç¾é‡‘æˆ–ä¿¡ç”¨å¡æ”¾åœ¨æ«ƒæª¯çš„å°ç›¤å­ä¸Šã€‚</li>
                        </ul>
                    </div>
                </div>
            );
        };

        // --- 6. Settings View ---
        const SettingsView = ({ travelers, setTravelers, setExpenses }) => {
            const [newName, setNewName] = useState('');

            const addTraveler = () => {
                if (newName && !travelers.includes(newName)) {
                    setTravelers([...travelers, newName]);
                    setNewName('');
                }
            };

            const removeTraveler = (name) => {
                if (travelers.length <= 1) return alert("è‡³å°‘éœ€è¦ä¸€ä½æ—…ä¼´");
                if (confirm(`åˆªé™¤æ—…ä¼´ ${name}ï¼Ÿæ³¨æ„ï¼šé€™å¯èƒ½æœƒå½±éŸ¿æ­·å²è¨˜å¸³è³‡æ–™é¡¯ç¤ºã€‚`)) {
                    setTravelers(travelers.filter(t => t !== name));
                }
            };

            const clearData = () => {
                if(confirm("è­¦å‘Šï¼šé€™å°‡æ¸…é™¤æ‰€æœ‰ App è³‡æ–™ä¸”ç„¡æ³•å¾©åŸï¼ç¢ºå®šå—ï¼Ÿ")) {
                    localStorage.clear();
                    window.location.reload();
                }
            }

            return (
                <div className="p-4 space-y-6">
                    <h2 className="text-lg font-bold text-gray-700">è¨­å®š</h2>

                    <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                        <h3 className="font-bold text-gray-700 mb-3">æ—…ä¼´ç®¡ç†</h3>
                        <div className="flex gap-2 mb-3">
                            <input 
                                type="text" 
                                placeholder="è¼¸å…¥åå­—..." 
                                className="border rounded p-2 flex-1"
                                value={newName}
                                onChange={e => setNewName(e.target.value)}
                            />
                            <button onClick={addTraveler} className="bg-blue-500 text-white px-4 rounded font-bold">æ–°å¢</button>
                        </div>
                        <div className="flex flex-wrap gap-2">
                            {travelers.map(t => (
                                <div key={t} className="bg-blue-50 text-blue-700 px-3 py-1 rounded-full flex items-center gap-2 text-sm">
                                    {t}
                                    <button onClick={() => removeTraveler(t)} className="text-blue-300 hover:text-red-500">Ã—</button>
                                </div>
                            ))}
                        </div>
                        <p className="text-xs text-gray-400 mt-2">* æ–°å¢æ—…ä¼´å¾Œï¼Œè¨˜å¸³æ™‚å³å¯é¸æ“‡è©²æˆå“¡ã€‚</p>
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                        <h3 className="font-bold text-gray-700 mb-3">è³‡æ–™ç®¡ç†</h3>
                        <button onClick={clearData} className="w-full border border-red-200 text-red-500 py-2 rounded hover:bg-red-50 transition">
                            æ¸…é™¤æ‰€æœ‰è³‡æ–™ä¸¦é‡ç½®
                        </button>
                    </div>
                    
                    <div className="text-center text-xs text-gray-400 mt-8">
                        æ²–ç¹©æ—…éŠå°å¹«æ‰‹ v1.0 <br/>
                        è³‡æ–™å„²å­˜æ–¼æœ¬æ©Ÿç€è¦½å™¨
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>