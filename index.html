<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ²–ç¹©å–®äººæ—…è²»é€š (å«é›™å¹£åˆ¥çµç®—)</title>
    
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        okinawa: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            900: '#0c4a6e',
                        },
                        converter: {
                            main: '#047857',
                            light: '#d1fae5',
                        },
                        finance: {
                            main: '#4f46e5', // Indigo
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .app-container { max-width: 480px; margin: 0 auto; min-height: 10vh; background-color: white; padding-bottom: 80px; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(5px); z-index: 100; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .animate-bounce-in { animation: bounceIn 0.3s ease-out forwards; }
        @keyframes bounceIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="app" class="app-container bg-gray-50 text-gray-800 relative">

    <!-- LOADING OVERLAY (åƒ…ç”¨æ–¼åŒ¯ç‡æŸ¥è©¢) -->
    <div v-if="loadingApi" class="loading-overlay z-[100] fixed inset-0">
        <i class="fa-solid fa-sync fa-spin text-4xl text-converter-main mb-4"></i>
        <p class="font-bold text-gray-700">æ­£åœ¨æŸ¥è©¢å°ç£éŠ€è¡Œæœ€æ–°åŒ¯ç‡...</p>
        <p class="text-sm text-gray-500 mt-2">è«‹ç¨å€™</p>
    </div>

    <!-- MAIN APP CONTENT -->
    <div>
        
        <!-- é ‚éƒ¨å°èˆª -->
        <header class="bg-gradient-to-r from-okinawa-500 to-teal-400 text-white p-4 sticky top-0 z-20 shadow-md rounded-b-2xl">
            <div class="flex justify-between items-center">
                <div>
                    <div class="flex items-center gap-2">
                        <h1 class="text-xl font-bold tracking-wide">æ²–ç¹©æ—…è²»é€š (å«é›™å¹£çµç®—)</h1>
                        <span class="bg-white/20 text-xs px-2 py-0.5 rounded text-white/90">LOCAL SAVE</span>
                    </div>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-xs opacity-90">è³‡æ–™å„²å­˜æ–¼æœ¬æ©Ÿç€è¦½å™¨</span>
                    </div>
                </div>
                <div @click="showSettings = true" class="cursor-pointer bg-white/20 p-2 rounded-full hover:bg-white/30 transition relative">
                    <i class="fa-solid fa-user-group"></i>
                </div>
            </div>
        </header>

        <main class="p-4 relative min-h-[calc(100vh-160px)]">
            
            <!-- Tab 1: è¡Œç¨‹è¡¨ -->
            <div v-if="currentTab === 'itinerary'" class="space-y-4">
                <!-- æ—¥æœŸé¸æ“‡ -->
                <div class="flex overflow-x-auto hide-scrollbar gap-3 pb-2 sticky top-[72px] z-10 bg-gray-50/95 backdrop-blur-sm py-2">
                    <button v-for="(day, index) in tripData.itinerary" :key="index" @click="activeDayIndex = index"
                        :class="activeDayIndex === index ? 'bg-okinawa-600 text-white shadow-lg scale-105' : 'bg-white text-gray-500 border border-gray-200'"
                        class="flex-shrink-0 px-4 py-2 rounded-xl flex flex-col items-center min-w-[70px] transition-all">
                        <span class="text-xs font-medium">Day {{ index + 1 }}</span>
                        <span class="text-sm font-bold">{{ formatDateShort(day.date) }}</span>
                    </button>
                    <button @click="addDay" class="flex-shrink-0 px-3 py-2 rounded-xl bg-gray-200 text-gray-500">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>

                <!-- è¡Œç¨‹åˆ—è¡¨ -->
                <div class="bg-white rounded-2xl p-4 shadow-sm min-h-[50vh]">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h2 class="font-bold text-lg text-gray-700">{{ tripData.itinerary[activeDayIndex]?.date }}</h2>
                        <div class="flex gap-2">
                            <button @click="editDayDate(activeDayIndex)" class="text-gray-400 hover:text-okinawa-600"><i class="fa-solid fa-pen"></i></button>
                            <button @click="deleteDay(activeDayIndex)" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>

                    <div class="relative pl-4 border-l-2 border-gray-100 space-y-6">
                        <div v-if="!tripData.itinerary[activeDayIndex]?.events.length" class="text-center py-8 text-gray-400">
                            <p>é»æ“Šä¸‹æ–¹æŒ‰éˆ•å®‰æ’è¡Œç¨‹</p>
                        </div>
                        <div v-for="(event, eIndex) in tripData.itinerary[activeDayIndex]?.events" :key="eIndex" class="relative group">
                            <div class="absolute -left-[25px] top-1 w-4 h-4 rounded-full border-2 border-white shadow-sm" :class="getIconColor(event.type)"></div>
                            <div class="bg-gray-50 hover:bg-white p-3 rounded-xl border border-transparent hover:border-gray-200 hover:shadow-md transition-all cursor-pointer" @click="openEditEventModal(activeDayIndex, eIndex)">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <span class="inline-block px-2 py-0.5 rounded text-xs font-bold text-white mb-1" :class="getIconColor(event.type)">
                                            {{ event.time }}
                                        </span>
                                        <h3 class="font-bold text-gray-800">{{ event.title }}</h3>
                                        <p class="text-sm text-gray-500 mt-1"><i class="fa-solid fa-location-dot mr-1 text-red-400"></i>{{ event.location }}</p>
                                        <!-- NEW: é¡¯ç¤ºå‚™è¨» -->
                                        <p v-if="event.notes" class="text-sm text-gray-600 mt-1 bg-white p-2 rounded-lg border-l-4 border-gray-300">
                                            <i class="fa-solid fa-note-sticky mr-1 text-gray-400"></i>
                                            {{ event.notes }}
                                        </p>
                                    </div>
                                    <a :href="getGoogleMapsLink(event.location)" target="_blank" @click.stop class="bg-blue-100 text-blue-600 p-2 rounded-full w-8 h-8 flex items-center justify-center">
                                        <i class="fa-solid fa-location-arrow text-xs"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button @click="openAddEventModal" class="w-full mt-6 py-3 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 hover:border-okinawa-500 hover:text-okinawa-500 transition font-medium">
                        <i class="fa-solid fa-plus mr-2"></i>æ–°å¢è¡Œç¨‹
                    </button>
                </div>
            </div>

            <!-- Tab 2: è²¡æ”¿ (åŒ¯ç‡ã€è¨˜å¸³èˆ‡çµç®—) -->
            <div v-else-if="currentTab === 'finance'" class="space-y-6">
                
                <!-- Sub-Tab Navigation (å°é ç±¤) -->
                <div class="flex overflow-x-auto hide-scrollbar gap-2 pb-2 sticky top-[72px] z-10 bg-gray-50/95 backdrop-blur-sm pt-2">
                    <button @click="currentFinanceSubTab = 'overview'" 
                        :class="currentFinanceSubTab === 'overview' ? 'bg-finance-main text-white shadow-lg' : 'bg-white text-gray-500 border border-gray-200'"
                        class="flex-shrink-0 px-4 py-2 rounded-xl text-sm font-bold transition-all">
                        <i class="fa-solid fa-chart-pie mr-1"></i>ç¸½è¦½èˆ‡æ›ç®—
                    </button>
                    <button @click="currentFinanceSubTab = 'settlement'" 
                        :class="currentFinanceSubTab === 'settlement' ? 'bg-finance-main text-white shadow-lg' : 'bg-white text-gray-500 border border-gray-200'"
                        class="flex-shrink-0 px-4 py-2 rounded-xl text-sm font-bold transition-all">
                        <i class="fa-solid fa-handshake-angle mr-1"></i>åˆ†å¸³çµç®—
                    </button>
                    <button @click="currentFinanceSubTab = 'expenses'" 
                        :class="currentFinanceSubTab === 'expenses' ? 'bg-finance-main text-white shadow-lg' : 'bg-white text-gray-500 border border-gray-200'"
                        class="flex-shrink-0 px-4 py-2 rounded-xl text-sm font-bold transition-all">
                        <i class="fa-solid fa-receipt mr-1"></i>è¨˜å¸³æ˜ç´°
                    </button>
                    <button @click="currentFinanceSubTab = 'rates'" 
                        :class="currentFinanceSubTab === 'rates' ? 'bg-finance-main text-white shadow-lg' : 'bg-white text-gray-500 border border-gray-200'"
                        class="flex-shrink-0 px-4 py-2 rounded-xl text-sm font-bold transition-all">
                        <i class="fa-solid fa-money-bill-transfer mr-1"></i>åŒ¯ç‡ç®¡ç†
                    </button>
                </div>

                <!-- Sub-Tab Content Area -->
                <div class="space-y-6 pt-2">
                    
                    <!-- Tab: ç¸½è¦½èˆ‡æ›ç®— (Overview) -->
                    <div v-if="currentFinanceSubTab === 'overview'" class="space-y-6">
                        
                        <!-- åŒ¯ç‡è½‰æ›å™¨ -->
                        <div class="bg-white rounded-2xl p-5 shadow-xl border-t-4 border-converter-main">
                            <h2 class="text-xl font-bold text-gray-800 mb-4 flex justify-between items-center">
                                åŒ¯ç‡ç®¡ç†èˆ‡æ›ç®—
                            </h2>
                            
                            <!-- è¼¸å…¥é‡‘é¡èˆ‡å¹£åˆ¥ -->
                            <div class="flex items-center gap-3">
                                <input type="number" v-model.number="conversionForm.amount" placeholder="è¼¸å…¥é‡‘é¡" class="w-full bg-gray-100 border-none rounded-xl p-4 text-xl font-bold text-converter-main focus:ring-2 focus:ring-converter-main focus:outline-none">
                                <select v-model="conversionForm.currency" class="bg-gray-200 text-gray-700 font-bold p-4 rounded-xl flex-shrink-0 focus:ring-2 focus:ring-converter-main">
                                    <option value="JPY">ğŸ‡¯ğŸ‡µ JPY</option>
                                    <option value="TWD">ğŸ‡¹ğŸ‡¼ TWD</option>
                                </select>
                            </div>

                            <!-- è½‰æ›çµæœ -->
                            <div class="text-center my-6">
                                <i class="fa-solid fa-down-long text-3xl text-gray-300 transform rotate-45"></i>
                            </div>

                            <div class="bg-converter-light p-4 rounded-xl border border-converter-main/20">
                                <p class="text-sm text-converter-main/80 font-bold mb-1">
                                    {{ conversionForm.currency === 'JPY' ? 'é ä¼°å°å¹£ (TWD)' : 'é ä¼°æ—¥å¹£ (JPY)' }}
                                </p>
                                <p class="text-3xl font-extrabold text-converter-main">
                                    {{ formatMoney(convertedAmount) }} 
                                    <span class="text-xl font-medium">{{ conversionForm.currency === 'JPY' ? 'TWD' : 'JPY' }}</span>
                                </p>
                            </div>
                            
                            <!-- ç›®å‰ä½¿ç”¨çš„åŒ¯ç‡ -->
                            <p class="text-xs text-gray-500 mt-4 text-center">
                                ç•¶å‰åŒ¯ç‡ (1 JPY = ? TWD): 
                                <span class="font-bold text-converter-main">{{ tripData.settings.currentRate.toFixed(4) }}</span>
                            </p>

                            <!-- NEW: åŒ¯ç‡æŸ¥è©¢æŒ‰éˆ•å€å¡Š -->
                            <div class="space-y-2 mt-3">
                                <!-- AI è‡ªå‹•ç²å– (ä¿ç•™åŸæœ¬åŠŸèƒ½) -->
                                <button @click="fetchLiveExchangeRate" :disabled="loadingApi" class="w-full py-2 bg-green-600 text-white rounded-xl font-bold shadow-md hover:bg-green-700 transition disabled:opacity-50 text-sm">
                                    <i :class="{'fa-spin': loadingApi}" class="fa-solid fa-sync mr-2"></i>
                                    {{ loadingApi ? 'AI æŸ¥è©¢ä¸­...' : 'AI è‡ªå‹•ç²å–æœ€æ–°åŒ¯ç‡' }}
                                </button>
                                <p class="text-xs text-gray-400 text-center">**AI æŸ¥è©¢çš„æ˜¯å°ç£éŠ€è¡Œç¾é‡‘è³£å‡ºåŒ¯ç‡**</p>
                                
                                <!-- ç›´æ¥é–‹å•Ÿç¶²é æŸ¥è©¢ (æ–°åŠŸèƒ½) -->
                                <a href="https://rate.bot.com.tw/xrt?Lang=zh-TW" target="_blank" class="block w-full text-center py-2 border-2 border-blue-500 text-blue-500 rounded-xl font-bold hover:bg-blue-50 transition text-sm">
                                    <i class="fa-solid fa-up-right-from-square mr-2"></i>ç›´æ¥é–‹å•Ÿå°ç£éŠ€è¡Œç¶²é æŸ¥è©¢
                                </a>
                            </div>
                        </div>

                        <!-- ç¸½æ”¯å‡ºæ¦‚è¦½ -->
                        <div class="bg-white rounded-2xl p-5 shadow-sm border-t-4 border-gray-400">
                            <h3 class="font-bold text-xl text-gray-800 border-b pb-2 flex justify-between items-center">
                                <i class="fa-solid fa-money-bill-wave mr-2 text-gray-400"></i>
                                ç¸½æ”¯å‡ºæ¦‚è¦½
                            </h3>
                            <div class="flex justify-between items-center text-lg p-3 rounded-xl bg-gray-100 shadow-inner mt-4">
                                <span class="font-bold text-gray-700">ç¸½æ”¯å‡º (TWD ä¼°ç®—)</span>
                                <span class="font-extrabold text-finance-main">NT$ {{ formatMoney(totalExpenseTWD) }}</span>
                            </div>
                            <button @click="openAddExpenseModal" class="w-full mt-4 bg-finance-main text-white px-3 py-2 rounded-xl text-sm font-bold shadow-md hover:bg-finance-main/90 transition">
                                <i class="fa-solid fa-plus mr-1"></i>æ–°å¢ä¸€ç­†è¨˜å¸³
                            </button>
                        </div>
                    </div>

                    <!-- Tab: åˆ†å¸³çµç®— (Settlement) -->
                    <div v-else-if="currentFinanceSubTab === 'settlement'" class="space-y-6">
                        
                        <!-- åˆ†å¸³çµç®— -->
                        <div class="bg-white rounded-2xl p-5 shadow-sm space-y-4 border-t-4 border-red-500">
                            <h3 class="font-bold text-xl text-gray-800 border-b pb-2 flex justify-between items-center">
                                <i class="fa-solid fa-handshake-angle mr-2 text-red-500"></i>
                                åˆ†å¸³çµç®— (TWD & JPY)
                            </h3>
                            
                            <div v-if="tripData.members.length > 1 && totalExpenseTWD > 0" class="space-y-3">
                                
                                <!-- çµç®—ç¸½è¡¨ (æ·¨é¤˜é¡) -->
                                <div class="bg-red-50 p-3 rounded-xl shadow-inner">
                                    <p class="text-sm font-bold text-red-700 mb-2">æˆå“¡æ·¨é¤˜é¡ (ç¸½ä»˜ - ç¸½æ”¤)</p>
                                    <div v-for="(balance, member) in memberBalances" :key="member" class="flex justify-between items-center py-1">
                                        <span class="font-medium text-gray-700">{{ member }}</span>
                                        <div class="text-right">
                                            <!-- é¡¯ç¤º TWD æ·¨é¤˜é¡ (åŸºç¤çµç®—è²¨å¹£) -->
                                            <p class="font-bold text-lg" :class="balance >= 0 ? 'text-green-600' : 'text-red-500'">
                                                NT$ {{ balance >= 0 ? '+' : '' }}{{ formatMoney(balance) }}
                                            </p>
                                            <!-- é¡¯ç¤º JPY é ä¼°å€¼ -->
                                            <p class="text-xs text-gray-400">
                                                â‰ˆ JPY {{ balance >= 0 ? '+' : '' }}{{ formatMoney(twdToJpy(balance)) }}
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <!-- çµç®—æ¸…å–® (èª°çµ¦èª°) -->
                                <div class="border-t pt-3 border-gray-100">
                                    <p class="text-sm font-bold text-gray-700 mb-2 flex items-center"><i class="fa-solid fa-arrow-right-arrow-left mr-2 text-red-500"></i>æœ€çµ‚çµç®—æ¸…å–®</p>
                                    <div v-if="settlementSummary.length === 0" class="p-4 text-center text-gray-500 bg-gray-50 rounded-lg">
                                        æ­å–œï¼ç›®å‰æ‰€æœ‰å¸³ç›®å·²çµæ¸…ã€‚
                                    </div>
                                    <div v-for="(settle, sIndex) in settlementSummary" :key="sIndex" class="flex items-center justify-between p-3 bg-white border-2 border-red-200 rounded-xl shadow-md">
                                        <div class="font-bold text-gray-800">
                                            {{ settle.debtor }} <i class="fa-solid fa-arrow-right text-red-500 mx-1"></i> {{ settle.creditor }}
                                        </div>
                                        <div class="text-right flex-shrink-0">
                                            <!-- é¡¯ç¤º TWD çµç®—é‡‘é¡ -->
                                            <p class="text-xl font-extrabold text-red-500">
                                                NT$ {{ formatMoney(settle.amount) }}
                                            </p>
                                            <!-- é¡¯ç¤º JPY é ä¼°çµç®—é‡‘é¡ -->
                                            <p class="text-sm text-gray-400 font-medium">
                                                â‰ˆ JPY {{ formatMoney(twdToJpy(settle.amount)) }}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div v-else class="p-4 text-center text-gray-400 bg-gray-50 rounded-lg">
                                <p v-if="tripData.members.length === 1">ç›®å‰åªæœ‰æ‚¨ä¸€ä½æˆå“¡ï¼Œç„¡éœ€åˆ†å¸³ã€‚</p>
                                <p v-else>å°šç„¡æ”¯å‡ºç´€éŒ„ï¼Œç„¡éœ€çµç®—ã€‚</p>
                            </div>

                        </div>
                    </div>

                    <!-- Tab: è¨˜å¸³æ˜ç´° (Expenses) -->
                    <div v-else-if="currentFinanceSubTab === 'expenses'" class="space-y-6">

                        <!-- è¨˜å¸³æ˜ç´° -->
                        <div class="bg-white rounded-2xl p-5 shadow-sm space-y-4 border-t-4 border-finance-main">
                            <h3 class="font-bold text-xl text-gray-800 border-b pb-2 flex justify-between items-center">
                                <i class="fa-solid fa-receipt mr-2 text-finance-main"></i>
                                è¨˜å¸³æ˜ç´°
                                <span class="text-sm font-normal text-gray-500">{{ tripData.expenses.length }} ç­†</span>
                            </h3>

                            <!-- è©³ç´°åˆ—è¡¨ -->
                            <div class="space-y-3 max-h-[60vh] overflow-y-auto hide-scrollbar">
                                <div v-if="tripData.expenses.length === 0" class="p-4 text-center text-gray-400 text-sm">å°šç„¡è¨˜å¸³ç´€éŒ„ï¼Œè«‹åœ¨ç¸½è¦½é ç±¤æ–°å¢ã€‚</div>
                                <div v-for="(exp, index) in sortedExpenses" :key="index" class="p-3 border rounded-xl shadow-sm bg-white hover:bg-gray-50 transition">
                                    <div class="flex justify-between items-center">
                                        <div class="min-w-0">
                                            <p class="font-bold text-gray-800 truncate">{{ exp.item }}</p>
                                            <p class="text-xs text-gray-500 mt-0.5">ä»˜æ¬¾äºº: <span class="font-medium text-finance-main">{{ exp.payer }}</span></p>
                                        </div>
                                        <div class="text-right flex-shrink-0">
                                            <p class="font-bold text-lg text-indigo-600">{{ exp.currency }}{{ formatMoney(exp.amount) }}</p>
                                            <p class="text-xs text-gray-400">â‰ˆ NT$ {{ formatMoney(exp.amountTWD) }}</p>
                                        </div>
                                    </div>
                                    <!-- åˆ†æ”¤ç´°ç¯€ (ç°¡åŒ–é¡¯ç¤º) -->
                                    <div class="mt-2 pt-2 border-t border-gray-100">
                                        <p class="text-xs font-bold text-gray-500 mb-1">åˆ†æ”¤æ˜ç´°:</p>
                                        <div class="flex flex-wrap gap-2">
                                            <span v-for="(share, member) in exp.shares" :key="member" class="text-xs px-2 py-0.5 rounded-full" :class="share > 0 ? 'bg-indigo-100 text-indigo-700' : 'bg-gray-100 text-gray-500'">
                                                {{ member }}: {{ exp.currency }}{{ formatMoney(share) }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="text-right mt-2">
                                        <button @click="deleteExpense(exp.originalIndex)" class="text-xs text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i> åˆªé™¤</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: åŒ¯ç‡ç®¡ç† (Rates) -->
                    <div v-else-if="currentFinanceSubTab === 'rates'" class="space-y-6">
                        
                        <!-- åŒ¯ç‡æ­·å²ç´€éŒ„ç®¡ç† (åƒ…ä¾›ç®¡ç†åŒ¯ç‡ç”¨) -->
                        <div class="bg-white rounded-2xl p-5 shadow-sm space-y-4">
                            <h3 class="font-bold text-lg text-gray-700 border-b pb-2">åŒ¯ç‡æ­·å²ç´€éŒ„</h3>
                            <div class="pt-3 border-t border-gray-100">
                                <h4 class="text-sm font-bold text-gray-600 mb-2">æ‰‹å‹•æ–°å¢åŒ¯ç‡ (1 JPY = X TWD)</h4>
                                <div class="flex gap-2">
                                    <input type="date" v-model="rateForm.date" class="bg-gray-50 border rounded-lg p-2 text-sm flex-1">
                                    <input type="number" step="0.0001" v-model.number="rateForm.rate" placeholder="0.xxxx" class="w-1/4 bg-gray-50 border rounded-lg p-2 text-sm text-center">
                                    <button @click="addHistoricalRate" class="bg-blue-600 text-white px-4 rounded-lg text-sm font-bold">å„²å­˜</button>
                                </div>
                            </div>
                            
                            <!-- æ­·å²åŒ¯ç‡åˆ—è¡¨ -->
                            <div class="space-y-2 mt-4 max-h-48 overflow-y-auto hide-scrollbar">
                                <div v-for="(rate, index) in sortedRates" :key="index" class="flex justify-between items-center p-3 bg-gray-50 rounded-lg" :class="{'border-2 border-converter-main/50': rate.rate === tripData.settings.currentRate}">
                                    <div class="flex items-center gap-3">
                                        <span class="text-sm font-bold text-gray-700 flex-shrink-0">{{ rate.date }}</span>
                                        <div class="text-xs text-gray-500">{{ rate.source }}</div>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-bold text-lg text-converter-main">{{ rate.rate.toFixed(4) }}</p>
                                        <button v-if="rate.rate !== tripData.settings.currentRate" @click="setAsCurrentRate(rate.rate)" class="text-xs text-blue-500 hover:text-blue-700">è¨­ç‚ºç•¶å‰</button>
                                        <button v-else class="text-xs text-converter-main font-bold">ç•¶å‰ä½¿ç”¨</button>
                                        <button @click="deleteHistoricalRate(index)" class="text-xs text-red-300 hover:text-red-500 ml-2"><i class="fa-solid fa-trash"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


            </div>

            <!-- Tab 3: åœ°åœ– -->
            <div v-else-if="currentTab === 'map'" class="space-y-4">
                <div class="bg-white rounded-2xl p-4 shadow-sm">
                    <h2 class="font-bold text-lg mb-4">è¡Œç¨‹å°èˆª</h2>
                    <div class="space-y-3">
                        <div v-for="loc in allLocations" :key="loc.id" class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="w-2 h-8 rounded-full bg-okinawa-500 flex-shrink-0"></div>
                            <div class="truncate flex-1 min-w-0">
                                <p class="font-bold text-sm truncate">{{ loc.name }}</p>
                                <p class="text-xs text-gray-400">Day {{ loc.dayIndex + 1 }}</p>
                            </div>
                            <a :href="getGoogleMapsLink(loc.name)" target="_blank" class="px-3 py-1.5 bg-white border border-gray-200 rounded-lg text-xs font-bold text-blue-600">Go</a>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- åº•éƒ¨å°èˆª -->
        <nav class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-100 flex justify-around py-3 pb-6 z-40 max-w-[480px] left-1/2 -translate-x-1/2 shadow-[0_-5px_10px_rgba(0,0,0,0.02)]">
            <button @click="currentTab = 'itinerary'" :class="currentTab === 'itinerary' ? 'text-okinawa-600' : 'text-gray-400'" class="flex flex-col items-center gap-1"><i class="fa-solid fa-suitcase-rolling text-xl"></i><span class="text-[10px]">è¡Œç¨‹</span></button>
            <button @click="currentTab = 'finance'" :class="currentTab === 'finance' ? 'text-finance-main' : 'text-gray-400'" class="flex flex-col items-center gap-1"><i class="fa-solid fa-coins text-xl"></i><span class="text-[10px]">è²¡æ”¿</span></button>
            <button @click="currentTab = 'map'" :class="currentTab === 'map' ? 'text-green-600' : 'text-gray-400'" class="flex flex-col items-center gap-1"><i class="fa-solid fa-map text-xl"></i><span class="text-[10px]">å°èˆª</span></button>
        </nav>
    </div>

    <!-- MODAL: æ–°å¢/ç·¨è¼¯è¡Œç¨‹ -->
    <div v-if="showEventModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50 p-4" @click.self="closeEventModal">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-bounce-in">
            <h3 class="text-lg font-bold mb-4">{{ isEditingEvent ? 'ç·¨è¼¯' : 'æ–°å¢' }}è¡Œç¨‹</h3>
            <div class="space-y-4">
                <div class="flex gap-2">
                    <input type="time" v-model="eventForm.time" class="bg-gray-50 border rounded-lg p-2.5 flex-1">
                    <select v-model="eventForm.type" class="bg-gray-50 border rounded-lg p-2.5 flex-1">
                        <option value="spot">æ™¯é»</option>
                        <option value="food">ç¾é£Ÿ</option>
                        <option value="hotel">ä½å®¿</option>
                        <option value="shop">è³¼ç‰©</option>
                    </select>
                </div>
                <input type="text" v-model="eventForm.title" placeholder="æ¨™é¡Œ (ä¾‹ï¼šæ°´æ—é¤¨)" class="w-full bg-gray-50 border rounded-lg p-2.5">
                <input type="text" v-model="eventForm.location" placeholder="åœ°é» (Google Maps æœå°‹ç”¨)" class="w-full bg-gray-50 border rounded-lg p-2.5">
                <!-- NEW: å‚™è¨»æ¬„ä½ -->
                <textarea v-model="eventForm.notes" placeholder="å‚™è¨» (ä¾‹å¦‚ï¼šè¨‚ä½è³‡è¨Šã€åœè»Šè³‡è¨Š)" rows="3" class="w-full bg-gray-50 border rounded-lg p-2.5 text-sm resize-none"></textarea>
            </div>
            <div class="flex gap-3 mt-6">
                <button v-if="isEditingEvent" @click="deleteEvent" class="px-4 py-2.5 text-red-500 bg-red-50 rounded-xl font-bold text-sm">åˆªé™¤</button>
                <button @click="saveEvent" class="flex-1 px-4 py-2.5 bg-okinawa-600 text-white rounded-xl font-bold text-sm">å„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- MODAL: è¨˜å¸³ (å…©æ­¥é©Ÿï¼šåŸºæœ¬è³‡è¨Š + åˆ†æ”¤é‡‘é¡) -->
    <div v-if="showExpenseModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50 p-4" @click.self="currentExpenseStep === 1 ? showExpenseModal = false : null">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
            <h3 class="text-lg font-bold mb-4 flex items-center">
                <span :class="currentExpenseStep === 1 ? 'text-finance-main' : 'text-gray-400'">1. åŸºæœ¬è³‡è¨Š</span> 
                <i class="fa-solid fa-arrow-right mx-2 text-sm text-gray-300"></i>
                <span :class="currentExpenseStep === 2 ? 'text-finance-main' : 'text-gray-400'">2. åˆ†æ”¤é‡‘é¡</span>
            </h3>

            <!-- Step 1: åŸºæœ¬è³‡è¨Š -->
            <div v-show="currentExpenseStep === 1" class="space-y-4">
                <input type="text" v-model="expenseForm.item" placeholder="é …ç›® (ä¾‹ï¼šç‡’è‚‰)" class="w-full bg-gray-50 border rounded-lg p-3">
                
                <div class="flex gap-2">
                    <div class="relative w-1/3">
                        <select v-model="expenseForm.currency" class="w-full h-full bg-gray-100 border-none rounded-lg p-3 appearance-none text-center font-bold">
                            <option value="JPY">ğŸ‡¯ğŸ‡µ JPY</option>
                            <option value="TWD">ğŸ‡¹ğŸ‡¼ TWD</option>
                        </select>
                        <i class="fa-solid fa-chevron-down absolute right-2 top-4 text-xs text-gray-400 pointer-events-none"></i>
                    </div>
                    <input type="number" v-model.number="expenseForm.amount" placeholder="é‡‘é¡" class="w-2/3 bg-gray-50 border rounded-lg p-3 text-xl font-bold text-indigo-600">
                </div>
                
                <div>
                    <label class="text-xs text-gray-400 font-bold mb-1 block">èª°ä»˜éŒ¢ï¼Ÿ (ä»˜æ¬¾äºº)</label>
                    <div class="flex flex-wrap gap-2 max-h-24 overflow-y-auto">
                        <button v-for="member in tripData.members" :key="member"
                            @click="expenseForm.payer = member"
                            :class="expenseForm.payer === member ? 'bg-finance-main text-white shadow-md' : 'bg-gray-100 text-gray-500'"
                            class="px-4 py-2 rounded-full text-sm font-bold transition">
                            {{ member }}
                        </button>
                    </div>
                </div>
                
                <button @click="nextExpenseStep" class="w-full mt-4 py-3 bg-finance-main text-white rounded-xl font-bold shadow-lg">ä¸‹ä¸€æ­¥ï¼šè¨­å®šåˆ†æ”¤</button>
            </div>

            <!-- Step 2: åˆ†æ”¤é‡‘é¡ -->
            <div v-show="currentExpenseStep === 2" class="space-y-4">
                <div class="bg-gray-100 p-3 rounded-xl">
                    <p class="text-sm font-bold text-gray-700">ç¸½é‡‘é¡: 
                        <span class="text-indigo-600">{{ expenseForm.currency }}{{ formatMoney(expenseForm.amount) }}</span>
                    </p>
                    <p class="text-sm font-bold text-gray-700">æœªåˆ†æ”¤é‡‘é¡: 
                        <span :class="{'text-red-500': remainingShare < 0, 'text-green-600': remainingShare === 0, 'text-orange-500': remainingShare > 0}">
                            {{ expenseForm.currency }}{{ formatMoney(remainingShare) }}
                        </span>
                    </p>
                </div>

                <div v-for="member in tripData.members" :key="member" class="flex items-center gap-3">
                    <span class="w-1/4 font-bold text-gray-700">{{ member }}</span>
                    <div class="flex-1 relative">
                         <input type="number" 
                                v-model.number="expenseForm.shares[member]" 
                                placeholder="åˆ†æ”¤é‡‘é¡" 
                                class="w-full bg-white border border-gray-300 rounded-lg p-3 text-lg font-bold text-center focus:ring-finance-main focus:border-finance-main">
                        <span class="absolute right-3 top-3.5 text-gray-500 font-medium">{{ expenseForm.currency }}</span>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button @click="currentExpenseStep = 1" class="w-1/3 py-3 bg-gray-200 text-gray-700 rounded-xl font-bold text-sm">ä¸Šä¸€æ­¥</button>
                    <button @click="saveExpense" :disabled="remainingShare !== 0" class="flex-1 py-3 text-white rounded-xl font-bold shadow-lg disabled:opacity-50" :class="remainingShare === 0 ? 'bg-finance-main hover:bg-finance-main/90' : 'bg-gray-500'">
                        <i class="fa-solid fa-save mr-2"></i>å„²å­˜è¨˜å¸³
                    </button>
                </div>
                <p v-if="remainingShare !== 0" class="text-xs text-red-500 text-center mt-2">è«‹ç¢ºä¿æ‰€æœ‰åˆ†æ”¤é‡‘é¡ç¸½å’Œç­‰æ–¼ç¸½é‡‘é¡ã€‚</p>
            </div>
        </div>
    </div>
    
    <!-- MODAL: æ—…ä¼´ç®¡ç†/æœ¬åœ°å„²å­˜ (è¨­å®š) -->
    <div v-if="showSettings" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50 p-4" @click.self="showSettings = false">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl h-[70vh] flex flex-col">
            <h3 class="text-lg font-bold mb-4 border-b pb-2">æ—…ä¼´ç®¡ç†èˆ‡å·¥å…·</h3>
            <div class="flex-1 overflow-y-auto space-y-6">
                
                <section>
                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">æ—…ä¼´åå–® (ç”¨æ–¼è¨˜å¸³åˆ†æ”¤)</h4>
                    <div class="flex flex-wrap gap-2 mb-2">
                        <div v-for="(m, i) in tripData.members" :key="i" class="bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full text-sm font-bold flex items-center gap-2">
                            {{ m }}
                            <button v-if="tripData.members.length > 1" @click="removeMember(i)" class="text-indigo-400 hover:text-indigo-600"><i class="fa-solid fa-xmark"></i></button>
                            <span v-else class="text-xs text-indigo-400">(é è¨­ä½¿ç”¨è€…)</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" v-model="newMemberName" placeholder="æ–°å¢åå­—" class="flex-1 bg-gray-50 border rounded-lg p-2 text-sm">
                        <button @click="addMember" class="bg-gray-800 text-white px-4 rounded-lg text-sm font-bold">æ–°å¢</button>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">æ­¤åå–®å°‡ç”¨æ–¼è¨˜å¸³æ™‚çš„ä»˜æ¬¾äººèˆ‡åˆ†æ”¤äººã€‚</p>
                </section>
                
                <section>
                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">æœ¬åœ°å„²å­˜è³‡è¨Š</h4>
                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-600">
                        <p>è³‡æ–™å·²å„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ã€‚</p>
                        <button @click="clearLocalData" class="text-xs text-red-500 hover:text-red-700 mt-1 font-medium">
                            <i class="fa-solid fa-bomb mr-1"></i> æ¸…ç©ºæ‰€æœ‰æœ¬åœ°è³‡æ–™
                        </button>
                    </div>
                </section>
            </div>
            <button @click="showSettings=false" class="mt-4 w-full py-3 bg-gray-100 text-gray-500 rounded-xl font-bold">é—œé–‰ç®¡ç†</button>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted, watch } = Vue;

    // --- Local Storage Configuration ---
    const STORAGE_KEY = 'okinawaTripDataV2';

    createApp({
        setup() {
            // --- State ---
            const userName = ref('æˆ‘'); // The only user
            const loadingApi = ref(false); 
            
            // App Data (Synced with Local Storage)
            const tripData = ref({
                itinerary: [{ date: new Date().toISOString().split('T')[0], events: [] }],
                expenses: [],
                members: ['æˆ‘'], // Default member is 'æˆ‘'
                settings: { 
                    currentRate: 0.23, // The rate currently used for display/conversion (1 JPY = ? TWD)
                    historicalRates: [
                        { date: '2025-06-01', rate: 0.23, source: 'åˆå§‹é è¨­å€¼' }
                    ]
                } 
            });

            // UI State
            const currentTab = ref('itinerary');
            const currentFinanceSubTab = ref('overview'); // Finance Sub-Tab State
            const activeDayIndex = ref(0);
            const showEventModal = ref(false);
            const showExpenseModal = ref(false);
            const showSettings = ref(false);
            const currentExpenseStep = ref(1); // 1: Basic Info, 2: Sharing

            // Forms
            const eventForm = ref({}); // Initialized in openAddEventModal
            const expenseForm = ref({}); // Initialized in openAddExpenseModal
            const newMemberName = ref('');
            
            // Converter Forms
            const conversionForm = ref({ amount: 10000, currency: 'JPY' });
            const rateForm = ref({
                date: new Date().toISOString().split('T')[0],
                rate: 0.2300,
                source: 'æ‰‹å‹•è¼¸å…¥'
            });
            
            // Helper for Editing Itinerary
            const isEditingEvent = ref(false);
            const editingIndices = ref({ d: -1, e: -1 });

            // --- Computed ---

            const remainingShare = computed(() => {
                if (!expenseForm.value.shares || !expenseForm.value.amount) return 0;
                
                const totalAmount = Number(expenseForm.value.amount) || 0;
                // Sum all shares
                const totalShares = Object.values(expenseForm.value.shares).reduce((sum, share) => sum + (Number(share) || 0), 0);
                
                // Use a small tolerance for floating point numbers
                const tolerance = 0.01;
                const diff = totalAmount - totalShares;
                
                if (Math.abs(diff) < tolerance) {
                    return 0; // Considered fully split
                }
                
                return diff;
            });

            const totalExpenseTWD = computed(() => {
                // Sum of all expenses' pre-calculated TWD values
                return tripData.value.expenses.reduce((sum, exp) => {
                    return sum + (Number(exp.amountTWD) || 0);
                }, 0);
            });

            const sortedExpenses = computed(() => {
                // Add original index to allow deletion
                return tripData.value.expenses.map((e, i) => ({...e, originalIndex: i})).reverse();
            });

            const allLocations = computed(() => {
                let locs = [];
                tripData.value.itinerary.forEach((day, dIdx) => {
                    day.events.forEach((evt, eIdx) => {
                        if(evt.location) {
                            locs.push({ id: `${dIdx}-${eIdx}`, name: evt.location, dayIndex: dIdx });
                        }
                    });
                });
                return locs;
            });
            
            const convertedAmount = computed(() => {
                const amount = Number(conversionForm.value.amount) || 0;
                const rate = tripData.value.settings.currentRate; // 1 JPY = X TWD
                
                if (conversionForm.value.currency === 'JPY') {
                    // JPY -> TWD
                    return amount * rate;
                } else {
                    // TWD -> JPY (1 TWD = 1/X JPY)
                    return amount / rate;
                }
            });

            const sortedRates = computed(() => {
                // Sort by date descending
                return [...tripData.value.settings.historicalRates]
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
            });
            
            // =======================================================
            // Member Balance & Settlement Calculation
            // =======================================================

            // 1. è¨ˆç®—æ¯ä½æˆå“¡çš„æ·¨é¤˜é¡ (Paid TWD - Shared TWD)
            const memberBalances = computed(() => {
                const balances = {};
                tripData.value.members.forEach(m => {
                    balances[m] = 0;
                });

                tripData.value.expenses.forEach(exp => {
                    const totalAmount = Number(exp.amount) || 0;
                    const totalAmountTWD = Number(exp.amountTWD) || 0;
                    
                    // Paid: If member is the payer, add the full TWD equivalent to their balance
                    if (exp.payer && balances.hasOwnProperty(exp.payer)) {
                        balances[exp.payer] += totalAmountTWD;
                    }

                    // Shared: Subtract the member's share (converted to TWD) from their balance
                    if (exp.shares) {
                        tripData.value.members.forEach(m => {
                            const shareAmount = Number(exp.shares[m]) || 0;
                            let shareTWD = 0;

                            if (totalAmount > 0) {
                                // Calculate TWD share based on the proportion of the original currency
                                shareTWD = (shareAmount / totalAmount) * totalAmountTWD;
                            }
                            
                            // Subtract the calculated TWD share
                            if (balances.hasOwnProperty(m)) {
                                balances[m] -= shareTWD;
                            }
                        });
                    }
                });

                // Round balances to avoid floating point errors
                for (const member in balances) {
                    // Round to nearest TWD dollar
                    balances[member] = Math.round(balances[member]); 
                }

                return balances;
            });

            // 2. ç”¢ç”Ÿæœ€çµ‚çµç®—æ¸…å–® (Settlement Summary)
            const settlementSummary = computed(() => {
                const balances = JSON.parse(JSON.stringify(memberBalances.value)); // Copy current balances
                const summary = [];

                // å€åˆ†å‚µæ¬Šäºº (Creditors: balance > 0) å’Œå‚µå‹™äºº (Debtors: balance < 0)
                let creditors = tripData.value.members
                    .map(m => ({ name: m, amount: balances[m] }))
                    .filter(c => c.amount > 0)
                    .sort((a, b) => b.amount - a.amount); // From largest creditor

                let debtors = tripData.value.members
                    .map(m => ({ name: m, amount: balances[m] * -1 })) // Amount is debt owed (positive)
                    .filter(d => d.amount > 0)
                    .sort((a, b) => b.amount - a.amount); // From largest debtor

                let dIndex = 0;
                let cIndex = 0;

                // è²ªå©ªæ¼”ç®—æ³• (Greedy Algorithm) çµç®—
                while (dIndex < debtors.length && cIndex < creditors.length) {
                    let debtor = debtors[dIndex];
                    let creditor = creditors[cIndex];

                    if (debtor.amount <= 0) {
                        dIndex++;
                        continue;
                    }
                    if (creditor.amount <= 0) {
                        cIndex++;
                        continue;
                    }

                    // çµç®—é‡‘é¡å–å…©è€…ä¸­çš„æœ€å°å€¼
                    const settlementAmount = Math.min(debtor.amount, creditor.amount);

                    summary.push({
                        debtor: debtor.name,
                        creditor: creditor.name,
                        amount: settlementAmount,
                    });

                    // æ›´æ–°å‰©é¤˜é¤˜é¡
                    debtor.amount -= settlementAmount;
                    creditor.amount -= settlementAmount;
                    
                    // Use tolerance for near-zero to avoid floating point issues
                    if (Math.abs(debtor.amount) < 1) { 
                        dIndex++;
                    }
                    if (Math.abs(creditor.amount) < 1) { 
                        cIndex++;
                    }
                }

                return summary;
            });

            // =======================================================
            // END: Member Balance & Settlement Calculation
            // =======================================================


            // --- Local Storage Logic ---
            const loadData = () => {
                const data = localStorage.getItem(STORAGE_KEY);
                if (data) {
                    const loadedData = JSON.parse(data);
                    
                    // Add default members if missing or empty
                    if (!loadedData.members || loadedData.members.length === 0) {
                        loadedData.members = [userName.value];
                    }
                    
                    tripData.value = loadedData;
                }
                
                // Ensure default payer exists
                if (!tripData.value.members.includes(userName.value)) {
                    tripData.value.members.push(userName.value);
                }
            };

            const saveData = () => {
                // Ensure the data structure is clean before saving
                const dataToSave = JSON.parse(JSON.stringify(tripData.value)); 
                localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
            };

            const clearLocalData = () => {
                // IMPORTANT: Replace window.confirm with a custom modal in a real app
                if(window.confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æœ¬åœ°è³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼')) {
                    localStorage.removeItem(STORAGE_KEY);
                    // Reload default state
                    tripData.value = {
                        itinerary: [{ date: new Date().toISOString().split('T')[0], events: [] }],
                        expenses: [],
                        members: ['æˆ‘'],
                        settings: { 
                            currentRate: 0.23, 
                            historicalRates: [{ date: new Date().toISOString().split('T')[0], rate: 0.23, source: 'åˆå§‹é è¨­å€¼' }]
                        } 
                    };
                    // Instead of alert, use a custom modal
                    console.log("æœ¬åœ°è³‡æ–™å·²æ¸…ç©ºï¼Œæ‡‰ç”¨ç¨‹å¼å·²é‡ç½®ã€‚");
                }
            };

            // --- Converter/Rate Methods ---
            const fetchLiveExchangeRate = async () => {
                loadingApi.value = true;
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                // ç³»çµ±æŒ‡ä»¤ï¼šå¼·èª¿åªè¼¸å‡ºæ•¸å­—ï¼Œä¸”æŒ‡å®šç‚ºç¾é‡‘è³£å‡ºåŒ¯ç‡
                const systemPrompt = "ä½ æ˜¯å°ˆæ¥­çš„é‡‘èåŠ©ç†ã€‚è«‹æŸ¥æ‰¾å°ç£éŠ€è¡Œæœ€æ–°çš„æ—¥åœ“ (JPY) å…Œæ›å°å¹£ (TWD) çš„**ç¾é‡‘è³£å‡ºåŒ¯ç‡**ï¼ˆå³éŠ€è¡Œè³£çµ¦å®¢æˆ¶çš„åƒ¹æ ¼ï¼Œ1 JPY = ? TWDï¼‰ã€‚è«‹**åƒ…è¼¸å‡ºæ•¸å­—**ï¼Œç²¾ç¢ºåˆ°å°æ•¸é»å¾Œå››ä½ã€‚ä¾‹å¦‚ï¼š0.2154";
                const userQuery = "å°ç£éŠ€è¡Œæœ€æ–°çš„æ—¥åœ“ç¾é‡‘è³£å‡ºåŒ¯ç‡æ˜¯å¤šå°‘ï¼Ÿ";
                
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    tools: [{ "google_search": {} }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                let attempt = 0;
                const maxRetries = 3;
                let newRate = null;
                let sources = []; 

                while (attempt < maxRetries) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        
                        const result = await response.json();
                        const candidate = result.candidates?.[0];
                        const text = candidate?.content?.parts?.[0]?.text?.trim();
                        
                        // ** é—œéµé™¤éŒ¯é» **ï¼šå…ˆå°å‡ºåŸå§‹è¼¸å‡ºï¼Œä»¥ç¢ºèªæ¨¡å‹æ˜¯å¦æœ‰éµå®ˆã€Œåƒ…è¼¸å‡ºæ•¸å­—ã€çš„æŒ‡ä»¤
                        console.log("--- API Rate Fetch Debug ---");
                        console.log("Raw API Output for Rate:", text);

                        const groundingMetadata = candidate?.groundingMetadata;
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title);
                        }
                        
                        // ** å„ªåŒ–è§£æé‚è¼¯ **
                        let extractedRate = null;
                        
                        // 1. å˜—è©¦å°‹æ‰¾ç¬¬ä¸€å€‹çœ‹èµ·ä¾†åƒåŒ¯ç‡çš„æ•¸å­— (0.xxx)
                        const rateMatch = text.match(/0\.\d{3,}/);
                        if (rateMatch) {
                            extractedRate = parseFloat(rateMatch[0]);
                        } else {
                            // 2. Fallback: æ¸…ç†éæ•¸å­—å’Œéé»çš„å­—å…ƒï¼Œå†å˜—è©¦è§£æ
                            // (é€™æœ‰é¢¨éšªï¼Œä½†å¯ä»¥æ‡‰å°æ¨¡å‹è¼¸å‡ºå¤šé¤˜æ–‡å­—çš„æƒ…æ³)
                            const cleanedText = text.replace(/[^\d.]/g, ''); 
                            extractedRate = parseFloat(cleanedText);
                        }
                        
                        console.log("Extracted Rate:", extractedRate);

                        // ç¢ºä¿åŒ¯ç‡æ˜¯ä¸€å€‹åˆç†çš„å€¼ (é€šå¸¸åœ¨ 0.001 åˆ° 10 ä¹‹é–“)
                        if (!isNaN(extractedRate) && extractedRate > 0.001 && extractedRate < 10) {
                            newRate = extractedRate;
                            break; // Success
                        } else {
                            console.warn("API returned invalid rate format, attempting retry or failing.");
                            throw new Error("Invalid rate format received from API.");
                        }

                    } catch (error) {
                        console.error(`Attempt ${attempt + 1} failed:`, error);
                        if (attempt < maxRetries - 1) {
                            // Exponential backoff
                            await new Promise(res => setTimeout(res, Math.pow(2, attempt) * 1000)); 
                        } else {
                            console.error("ç„¡æ³•ç²å–å°ç£éŠ€è¡Œå³æ™‚åŒ¯ç‡ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚");
                        }
                    }
                    attempt++;
                }
                
                if (newRate) {
                    const roundedRate = parseFloat(newRate.toFixed(4));
                    tripData.value.settings.currentRate = roundedRate;
                    
                    const sourceInfo = sources.length > 0 ? sources[0].title || sources[0].uri : 'å°ç£éŠ€è¡Œ (AI æŸ¥è©¢)';

                    const today = new Date().toISOString().split('T')[0];
                    const existingTodayIndex = tripData.value.settings.historicalRates.findIndex(r => r.date === today && r.source.includes('å°ç£éŠ€è¡Œ'));
                    
                    if (existingTodayIndex !== -1) {
                        tripData.value.settings.historicalRates[existingTodayIndex].rate = roundedRate;
                        tripData.value.settings.historicalRates[existingTodayIndex].source = sourceInfo;
                    } else {
                        tripData.value.settings.historicalRates.push({ 
                            date: today, 
                            rate: roundedRate, 
                            source: sourceInfo 
                        });
                    }
                    saveData();
                    console.log(`å·²æˆåŠŸæ›´æ–°æœ€æ–°åŒ¯ç‡ï¼š1 JPY â‰ˆ ${roundedRate.toFixed(4)} TWD (ä¾†æºï¼šAI æŸ¥è©¢)`);
                }
                
                loadingApi.value = false;
            };

            const addHistoricalRate = () => {
                // Instead of alert, use custom modal or console log
                if (!rateForm.value.date || !rateForm.value.rate || rateForm.value.rate <= 0) {
                    console.error('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ—¥æœŸå’ŒåŒ¯ç‡ (å¿…é ˆå¤§æ–¼ 0)');
                    return;
                }
                const newRateObj = {
                    date: rateForm.value.date,
                    rate: parseFloat(rateForm.value.rate.toFixed(4)),
                    source: 'æ‰‹å‹•è¼¸å…¥'
                };

                const exists = tripData.value.settings.historicalRates.some(r => r.date === newRateObj.date && r.rate === newRateObj.rate);
                if (exists) {
                    console.warn('æ­¤æ—¥æœŸå’ŒåŒ¯ç‡å·²å­˜åœ¨æ–¼ç´€éŒ„ä¸­ã€‚');
                    return;
                }

                tripData.value.settings.historicalRates.push(newRateObj);
                rateForm.value.rate = 0.2300; // Reset form
                saveData();
            };

            const deleteHistoricalRate = (index) => {
                const rateToDelete = sortedRates.value[index];
                const originalIndex = tripData.value.settings.historicalRates.findIndex(r => 
                    r.date === rateToDelete.date && r.rate === rateToDelete.rate
                );

                if (originalIndex !== -1) {
                    if (tripData.value.settings.currentRate === rateToDelete.rate && tripData.value.settings.historicalRates.length > 1) {
                        console.error('ç„¡æ³•åˆªé™¤æ­£åœ¨ä½¿ç”¨çš„åŒ¯ç‡ï¼Œè«‹å…ˆåˆ‡æ›è‡³å…¶ä»–åŒ¯ç‡ã€‚');
                        return;
                    }
                    
                    // Instead of window.confirm, use a custom modal
                    if(confirm(`ç¢ºå®šåˆªé™¤ ${rateToDelete.date} çš„åŒ¯ç‡ ${rateToDelete.rate.toFixed(4)} å—ï¼Ÿ`)) {
                        tripData.value.settings.historicalRates.splice(originalIndex, 1);
                        saveData();
                    }
                }
            };

            const setAsCurrentRate = (rate) => {
                tripData.value.settings.currentRate = rate;
                saveData();
            };
            
            // --- Expense Methods ---

            const openAddExpenseModal = () => {
                const initialShares = tripData.value.members.reduce((acc, member) => {
                    acc[member] = 0;
                    return acc;
                }, {});

                expenseForm.value = { 
                    item: '', 
                    amount: null, 
                    currency: 'JPY', 
                    payer: userName.value,
                    shares: initialShares
                };
                currentExpenseStep.value = 1;
                showExpenseModal.value = true;
            };

            const nextExpenseStep = () => {
                const amount = Number(expenseForm.value.amount);
                // Instead of alert, use custom modal or console log
                if(!expenseForm.value.item || !amount || amount <= 0 || !expenseForm.value.payer) {
                    console.error('è«‹è¼¸å…¥æœ‰æ•ˆçš„é …ç›®ã€é‡‘é¡å’Œä»˜æ¬¾äººã€‚');
                    return;
                }
                
                if (tripData.value.members.length === 1) {
                    expenseForm.value.shares[tripData.value.members[0]] = amount;
                }
                
                currentExpenseStep.value = 2;
            };

            const saveExpense = () => {
                // Instead of alert, use custom modal or console log
                if (remainingShare.value !== 0) {
                    console.error('è«‹ç¢ºä¿æ‰€æœ‰åˆ†æ”¤é‡‘é¡ç¸½å’Œç­‰æ–¼ç¸½é‡‘é¡ã€‚');
                    return;
                }
                
                const currentRate = tripData.value.settings.currentRate;
                const amount = Number(expenseForm.value.amount);
                
                const amountTWD = expenseForm.value.currency === 'JPY' 
                    ? amount * currentRate
                    : amount;

                tripData.value.expenses.push({
                    ...expenseForm.value,
                    amount: amount, 
                    amountTWD: amountTWD, 
                    date: new Date().toISOString()
                });
                
                saveData();
                showExpenseModal.value = false;
                // åˆ‡æ›åˆ°è¨˜å¸³æ˜ç´°é ç±¤ä»¥æŸ¥çœ‹æ–°å¢çš„é …ç›®
                currentFinanceSubTab.value = 'expenses'; 
            };

            const deleteExpense = (originalIndex) => {
                // Instead of window.confirm, use a custom modal
                if(confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†æ¬¾é …å—ï¼Ÿ')) { 
                    tripData.value.expenses.splice(originalIndex, 1);
                    saveData();
                }
            };

            const addMember = () => {
                if(newMemberName.value && !tripData.value.members.includes(newMemberName.value)) {
                    tripData.value.members.push(newMemberName.value);
                    newMemberName.value = '';
                    saveData();
                }
            };
            
            const removeMember = (idx) => {
                // Instead of alert, use custom modal or console log
                if (tripData.value.members.length <= 1) {
                    console.error('ç„¡æ³•ç§»é™¤æœ€å¾Œä¸€å€‹æˆå“¡ã€‚');
                    return;
                }
                const memberToRemove = tripData.value.members[idx];
                const isUsed = tripData.value.expenses.some(exp => 
                    exp.payer === memberToRemove || (exp.shares && exp.shares.hasOwnProperty(memberToRemove) && exp.shares[memberToRemove] > 0)
                );
                
                if(isUsed) {
                    console.error(`æˆå“¡ ${memberToRemove} ä»åœ¨ç¾æœ‰çš„è¨˜å¸³ç´€éŒ„ä¸­ä½œç‚ºä»˜æ¬¾äººæˆ–åˆ†æ”¤äººï¼Œè«‹å…ˆç§»é™¤ç›¸é—œç´€éŒ„å¾Œå†åˆªé™¤æˆå“¡ã€‚`);
                    return;
                }

                // Instead of window.confirm, use a custom modal
                if(confirm(`ç¢ºå®šç§»é™¤æˆå“¡ ${memberToRemove} å—ï¼Ÿ`)) {
                    tripData.value.members.splice(idx, 1);
                    saveData();
                }
            };

            // --- Itinerary Methods ---
            
            const addDay = () => {
                const last = new Date(tripData.value.itinerary[tripData.value.itinerary.length-1].date);
                last.setDate(last.getDate()+1);
                tripData.value.itinerary.push({ date: last.toISOString().split('T')[0], events: [] });
                saveData();
            };

            const deleteDay = (idx) => {
                // Instead of window.confirm, use a custom modal
                if(confirm('åˆªé™¤é€™å¤©ï¼Ÿ')) {
                    tripData.value.itinerary.splice(idx, 1);
                    if(activeDayIndex.value >= tripData.value.itinerary.length) activeDayIndex.value--;
                    saveData();
                }
            };
            
            const editDayDate = (idx) => {
                // Using prompt is discouraged, but kept here for simplicity as it's not a core interaction
                const d = prompt("æ–°æ—¥æœŸ (YYYY-MM-DD)", tripData.value.itinerary[idx].date);
                if(d) { tripData.value.itinerary[idx].date = d; saveData(); }
            };

            const openAddEventModal = () => {
                isEditingEvent.value = false;
                // NEW: Initialize with notes
                eventForm.value = { time: '10:00', type: 'spot', title: '', location: '', notes: '' };
                showEventModal.value = true;
            };

            const openEditEventModal = (d, e) => {
                isEditingEvent.value = true;
                editingIndices.value = { d, e };
                // NEW: Ensure notes is loaded when editing
                eventForm.value = { ...tripData.value.itinerary[d].events[e] };
                showEventModal.value = true;
            };

            const saveEvent = () => {
                // Instead of alert, use custom modal or console log
                if(!eventForm.value.title) { console.error('è«‹è¼¸å…¥æ¨™é¡Œ'); return; }
                if(isEditingEvent.value) {
                    tripData.value.itinerary[editingIndices.value.d].events[editingIndices.value.e] = {...eventForm.value};
                } else {
                    tripData.value.itinerary[activeDayIndex.value].events.push({...eventForm.value});
                    tripData.value.itinerary[activeDayIndex.value].events.sort((a,b) => a.time.localeCompare(b.time));
                }
                saveData();
                showEventModal.value = false;
            };

            const deleteEvent = () => {
                tripData.value.itinerary[editingIndices.value.d].events.splice(editingIndices.value.e, 1);
                saveData();
                showEventModal.value = false;
            };
            
            // --- New Utility: TWD to JPY conversion for Display ---
            const twdToJpy = (twdAmount) => {
                const rate = tripData.value.settings.currentRate;
                if (rate <= 0) return 0;
                // JPY equivalent = TWD Amount / (1 JPY = X TWD)
                return Math.round(twdAmount / rate);
            };


            // --- General Utilities ---
            const formatDateShort = (d) => { const date = new Date(d); return `${date.getMonth()+1}/${date.getDate()}`; };
            // Format money to string with commas, rounding to 0 decimals for TWD display
            const formatMoney = (n) => {
                // Ensure the number is positive for formatting, take Math.abs()
                const absoluteN = Math.abs(Number(n));
                return absoluteN.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            };
            const getIconColor = (t) => ({'spot':'bg-blue-500','food':'bg-orange-500','hotel':'bg-purple-500','shop':'bg-pink-500'}[t]||'bg-gray-400');
            const getGoogleMapsLink = (loc) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc + ' æ²–ç¹©')}`;
            const closeEventModal = () => showEventModal.value = false;
            
            // --- Lifecycle Hook ---
            onMounted(() => {
                loadData();
                // Ensure the active day index is valid upon load
                if (activeDayIndex.value >= tripData.value.itinerary.length) {
                    activeDayIndex.value = tripData.value.itinerary.length > 0 ? tripData.value.itinerary.length - 1 : 0;
                }
            });

            // Watch for changes in tripData and save automatically
            watch(tripData, saveData, { deep: true });

            // Watch expense amount change to auto-update single share
            watch(() => expenseForm.value.amount, (newAmount) => {
                if (currentExpenseStep.value === 2 && tripData.value.members.length === 1 && expenseForm.value.shares) {
                    expenseForm.value.shares[tripData.value.members[0]] = Number(newAmount) || 0;
                }
            });
            
            watch(() => expenseForm.value.currency, () => {
                if (expenseForm.value.shares) {
                    tripData.value.members.forEach(member => {
                        expenseForm.value.shares[member] = 0;
                    });
                }
            });

            return {
                userName, tripData, loadingApi,
                currentTab, currentFinanceSubTab, 
                activeDayIndex, showEventModal, showExpenseModal, showSettings,
                currentExpenseStep, remainingShare,
                eventForm, expenseForm, newMemberName, conversionForm, rateForm, isEditingEvent,
                
                addDay, deleteDay, editDayDate, 
                openAddEventModal, openEditEventModal, saveEvent, deleteEvent, closeEventModal,
                openAddExpenseModal, saveExpense, nextExpenseStep, deleteExpense,
                addMember, removeMember, clearLocalData,
                
                // Finance Computed/Methods
                memberBalances, settlementSummary, twdToJpy,
                fetchLiveExchangeRate, addHistoricalRate, deleteHistoricalRate, setAsCurrentRate,
                convertedAmount, sortedRates,
                
                totalExpenseTWD, sortedExpenses, allLocations,
                formatDateShort, formatMoney, getIconColor, getGoogleMapsLink
            };
        }
    }).mount('#app');
</script>
</body>
</html>